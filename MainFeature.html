<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALVIS - Video Transfer</title>
  <link rel="stylesheet" href="styles.css">
  <link href="main.css" rel="stylesheet" type="text/css">
  <link href="style.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      color: #000; /* Ensure text is visible against background */
    }
    .drop-area {
      border: 2px dashed #ccc;
      border-radius: 20px;
      width: 100%;
      padding: 20px;
      text-align: center;
      font-size: 18px;
      color: #aaa;
      margin: 20px 0;
    }
    .drop-area.dragover {
      border-color: #000;
      color: #000;
    }
    .device-list, .new-device-list, .link-options {
      display: none;
      margin-top: 20px;
    }
    .device-list.active, .new-device-list.active, .link-options.active {
      display: block;
    }
    .device-item {
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
    }
    .button {
      margin: 10px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body class="bgColor">
  <audio id="backgroundAudio" autoplay loop>
    <source src="Hotham - Sunset Drive.wav" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <header class="header bgColor">
    <section class="mainTitle">
      <h1 id="mainTitle" data-lang="mainTitle">ALVIS - JARVIS 2.0</h1>
    </section>
    <section>
      <div class="nav">
        <a href="index.html" class="logoo"><img class="logo" src="Images/Alvislogo.webp" alt="Image"></a>
        <a href="/apps.html" data-lang="apps">Apps</a>
        <a href="/personalization.html" data-lang="personalization">Personalization</a>
        <a href="#">
          <label for="language" data-lang="languageLabel">Language:</label>
          <select name="Language" id="language">
            <option value="en" selected>English</option>
            <option value="zh">Mandarin</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="es">Spanish</option>
          </select>
        </a>
        <a href="/logIn.html" target="_blank" data-lang="login">Log In</a>
        <a href="/" data-lang="signup">Sign Up</a>
        <a id="muteButton">Mute</a>
        <a href="/MainFeature.html">Main</a>
      </div>
    </section>
  </header>

  <main>
    <h1>Welcome to ALVIS AI</h1>
    <div class="drop-area" id="drop-area">
      Drag and drop a link to a Netflix movie, show, or YouTube video here
    </div>
    <div id="link-output" style="display:none;">
      <h2>Selected Video:</h2>
      <p id="selected-link"></p>
      <button class="button" onclick="showLinkOptions()">Next</button>
    </div>

    <div class="link-options" id="link-options">
      <button class="button" onclick="showDevices()">Connect to a Previous Device</button>
      <button class="button" onclick="showNewDevices()">Connect to a New Device</button>
      <button class="button" onclick="goBackFromLinkOptions()">Back</button>
    </div>

    <div class="device-list" id="device-list">
      <h2>Previously Connected Devices</h2>
      <div id="devices"></div>
      <button class="button" onclick="goBackFromDeviceList()">Back</button>
    </div>

    <div class="new-device-list" id="new-device-list">
      <h2>New Devices</h2>
      <button class="button" onclick="findNewDevices()">Find New Devices</button>
      <div id="new-devices"></div>
      <button class="button" onclick="goBackFromNewDeviceList()">Back</button>
    </div>
  </main>

  <footer></footer>

  <script>
    let ws;

    function getStoredDevices() {
      const storedDevices = localStorage.getItem('connectedDevices');
      return storedDevices ? JSON.parse(storedDevices) : [];
    }

    function storeDevice(device) {
      const storedDevices = getStoredDevices();
      if (!storedDevices.some(d => d.id === device.id)) {
        storedDevices.push({ id: device.id, name: device.name || 'Unknown Device' });
        localStorage.setItem('connectedDevices', JSON.stringify(storedDevices));
      }
    }

    async function checkProximity() {
      const storedDevices = getStoredDevices();
      if (storedDevices.length === 0) {
        return false;
      }

      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: storedDevices.map(d => ({ name: d.name })),
          optionalServices: ['battery_service']
        });
        storeDevice(device);
        return device.gatt.connected;
      } catch (error) {
        console.error('Bluetooth proximity check failed:', error);
        return false;
      }
    }

    async function notifyUser() {
      const isNear = await checkProximity();
      if (isNear) {
        document.getElementById('notification').style.display = 'block';
      }
    }

    function connectToTV() {
      ws = new WebSocket('ws://localhost:3000');

      ws.onopen = () => {
        console.log('WebSocket connection established');
        ws.send('Connecting to TV...');
        alert('Connected to TV!');
      };

      ws.onmessage = (event) => {
        console.log('Message from server:', event.data);
      };

      ws.onclose = () => {
        console.log('WebSocket connection closed');
        alert('Disconnected from TV');
      };

      document.getElementById('notification').style.display = 'none';
    }

    function dismissNotification() {
      document.getElementById('notification').style.display = 'none';
    }

    // Drag and drop functionality
    const dropArea = document.getElementById('drop-area');
    const linkOutput = document.getElementById('link-output');
    const selectedLink = document.getElementById('selected-link');
    const linkOptions = document.getElementById('link-options');
    const deviceList = document.getElementById('device-list');
    const newDeviceList = document.getElementById('new-device-list');

    dropArea.addEventListener('dragover', (event) => {
      event.preventDefault();
      dropArea.classList.add('dragover');
    });

    dropArea.addEventListener('dragleave', () => {
      dropArea.classList.remove('dragover');
    });

    dropArea.addEventListener('drop', (event) => {
      event.preventDefault();
      dropArea.classList.remove('dragover');
      const link = event.dataTransfer.getData('text');
      if (link) {
        selectedLink.textContent = link;
        linkOutput.style.display = 'block';
      }
    });

    function showLinkOptions() {
      linkOutput.style.display = 'none';
      linkOptions.classList.add('active');
    }

    function showDevices() {
      linkOptions.classList.remove('active');
      deviceList.classList.add('active');
      const devices = getStoredDevices();
      const devicesDiv = document.getElementById('devices');
      devicesDiv.innerHTML = '';
      devices.forEach(device => {
        const deviceElement = document.createElement('div');
        deviceElement.className = 'device-item';
        deviceElement.textContent = device.name || 'Unknown Device';
        deviceElement.addEventListener('click', () => connectToDevice(device));
        devicesDiv.appendChild(deviceElement);
      });
    }

    function showNewDevices() {
      linkOptions.classList.remove('active');
      newDeviceList.classList.add('active');
    }

    async function findNewDevices() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['battery_service']
        });

        // Use logical operators to filter devices
        if (device.name && device.gatt.connected) {
          storeDevice(device);
          const newDevicesDiv = document.getElementById('new-devices');
          const deviceElement = document.createElement('div');
          deviceElement.className = 'device-item';
          deviceElement.textContent = device.name;
          deviceElement.addEventListener('click', () => connectToDevice(device));
          newDevicesDiv.appendChild(deviceElement);
        } else if (device.name && !device.gatt.connected) {
          console.log('Device found but not connected:', device.name);
        } else if (!device.name && device.gatt.connected) {
          console.log('Device connected but has no name');
        } else {
          console.log('Unsupported or unavailable device');
        }

      } catch (error) {
        console.error('Bluetooth device search failed:', error);
      }
    }

    function connectToDevice(device) {
      ws = new WebSocket('ws://localhost:3000');

      ws.onopen = () => {
        console.log('WebSocket connection established');
        ws.send(`Connecting to device ${device.name || 'Unknown Device'}`);
        alert(`Connected to device ${device.name || 'Unknown Device'}!`);
      };

      ws.onmessage = (event) => {
        console.log('Message from server:', event.data);
      };

      ws.onclose = () => {
        console.log('WebSocket connection closed');
        alert(`Disconnected from device ${device.name || 'Unknown Device'}`);
      };
    }

    function goBackFromLinkOptions() {
      linkOptions.classList.remove('active');
      linkOutput.style.display = 'block';
    }

    function goBackFromDeviceList() {
      deviceList.classList.remove('active');
      linkOptions.classList.add('active');
    }

    function goBackFromNewDeviceList() {
      newDeviceList.classList.remove('active');
      linkOptions.classList.add('active');
    }

    // Check for proximity every 10 seconds
    setInterval(notifyUser, 10000);
  </script>
</body>
</html>
